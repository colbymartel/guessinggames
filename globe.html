<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spin The Globe | Guessing Games</title>
  <link rel="icon" href="/favicongg.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #3b7bbf 0%, #2a5a8a 100%);
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    nav {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      padding: 14px 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    nav .left a { color:#333; text-decoration:none; margin-right:16px; font-weight:600; }
    nav .right { display:flex; gap:10px; align-items:center; }
    .search { padding: 8px 12px; height: 38px; width: 240px; border-radius: 20px; border: 2px solid #e0e0e0; }
    .btn {
      background: linear-gradient(135deg, #3b7bbf, #2a5a8a);
      color: #fff; border: none; padding: 10px 18px;
      border-radius: 20px; font-weight: 700; cursor:pointer;
    }

    main {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: calc(100vh - 80px);
      padding: 20px;
    }
    h1 { color: #fff; font-size: 2.4rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px; }
    .stats {
      display:inline-flex; gap:14px; align-items:center;
      margin: 12px 0 25px; padding: 12px 18px; border-radius: 22px;
      background: rgba(255,255,255,0.95); font-weight: 700;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* FIXED globe size: always 460x460 */
    .globe-wrap {
      position: relative;
      width: 460px;
      height: 460px;
      margin: 0 auto 30px;
      border-radius: 16px;
      overflow: hidden;
      background: radial-gradient(ellipse at center, rgba(255,255,255,0.1), rgba(0,0,0,0) 60%);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #globeViz {
      width: 100%;
      height: 100%;
      display:flex; align-items:center; justify-content:center;
    }
    .pointer {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      width:0; height:0; border-left: 16px solid transparent; border-right: 16px solid transparent;
      border-top: 26px solid #ff4444; z-index: 5;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    .panel {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
      margin: 0 auto 20px; padding: 20px; border-radius: 16px; max-width: 520px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .country-name { font-size: 1.5rem; font-weight: 800; color:#333; margin-bottom: 8px; }
    .timer { font-size: 2rem; font-weight: 800; color:#ff4444; margin: 12px 0; }

    .input { margin: 15px 0; }
    .guess {
      padding: 14px 16px; font-size: 1.05rem; border: 2px solid #e0e0e0; border-radius: 26px;
      width: 300px; font-family: 'Montserrat', sans-serif;
    }
    .guess:focus { outline: none; border-color: #3b7bbf; }
    .controls { margin-top: 15px; display:flex; justify-content:center; gap:12px; flex-wrap: wrap; }

    .strikes { display:flex; justify-content:center; gap:10px; margin: 15px 0; }
    .strike { width: 30px; height: 30px; border-radius: 50%; background:#ddd; border:2px solid #999; }
    .strike.used { background:#ff4444; border-color:#cc0000; }

    #message {
      color:#fff; font-size:1.1rem; font-weight:700;
      text-shadow:0 2px 4px rgba(0,0,0,0.35); min-height: 28px; margin-top: 10px;
    }
    #playAgain { display:none; }

    /* Optional: if a screen is narrower than 460px, allow horizontal scroll rather than shrinking the globe */
    @media (max-width: 480px){
      body { overflow-x: auto; }
    }
  </style>
</head>
<body>
  <nav>
    <div class="left">
      <a href="/index.html">Home</a>
      <a href="/allgames.html">Games</a>
      <a href="/about.html">About</a>
    </div>
    <div class="right">
      <input class="search" placeholder="Search games..." />
      <button class="btn">Login</button>
    </div>
  </nav>

  <main>
    <h1>üåç Spin The Globe</h1>
    <div class="stats">
      <div id="score">Score: 0</div>
      <div>|</div>
      <div id="high">High Score: 0</div>
    </div>

    <div class="globe-wrap">
      <div class="pointer"></div>
      <div id="globeViz">
        <div style="color: white; padding: 20px; text-align: center; font-size: 1.2rem;">
          Loading 3D Globe...
        </div>
      </div>
    </div>

    <div class="panel" id="countryPanel">
      <div class="country-name" id="maskedName">Click "Spin Globe" to start!</div>
      <div class="timer" id="timer">10</div>
      <div class="input">
        <input id="guess" class="guess" placeholder="Type the country name..." autocomplete="off" />
      </div>
      <div class="controls">
        <button class="btn" id="submitBtn">Submit</button>
        <button class="btn" id="spinBtn">Spin Globe</button>
        <button class="btn" id="playAgain">Play Again</button>
      </div>
    </div>

    <div class="strikes">
      <div class="strike" id="s1"></div>
      <div class="strike" id="s2"></div>
      <div class="strike" id="s3"></div>
    </div>

    <div id="message"></div>
  </main>

  <!-- libs -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/d3@7"></script>
  <script src="https://unpkg.com/globe.gl@2.32.1/dist/globe.gl.min.js"></script>

  <script>
  // ---------- Game State ----------
  let globe, worldFeatures = [], selected = null, timerId = null;
  let score = 0, strikes = 0, timeLeft = 10, spinning = false;
  const highKey = 'globeGameHighScoreV5';
  const highVal = Number(localStorage.getItem(highKey) || 0);
  document.getElementById('high').textContent = `High Score: ${highVal}`;

  const maskedNameEl = document.getElementById('maskedName');
  const timerEl = document.getElementById('timer');
  const msgEl = document.getElementById('message');
  const guessInput = document.getElementById('guess');
  const submitBtn = document.getElementById('submitBtn');
  const spinBtn = document.getElementById('spinBtn');
  const playAgainBtn = document.getElementById('playAgain');

  // Alias map for common country name variants
  const alias = new Map([
    ['usa','united states'], ['u.s.a','united states'], ['us','united states'], ['united states of america','united states'],
    ['russian federation','russia'], ['uk','united kingdom'], ['u.k','united kingdom'], ['england','united kingdom'],
    ['south korea','korea, republic of'], ['north korea','korea, democratic people\'s republic of'],
    ['congo','democratic republic of the congo'], ['drc','democratic republic of the congo'],
    ['czechia','czech republic'], ['eswatini','swaziland'], ['cape verde','cabo verde'],
    ['ivory coast','c√¥te d\'ivoire'], ['republic of the congo','congo'], ['bolivia','bolivia (plurinational state of)'],
    ['venezuela','venezuela (bolivarian republic of)'], ['syria','syrian arab republic'],
    ['laos','lao people\'s democratic republic'], ['moldova','moldova, republic of'],
    ['palestine','palestine, state of'], ['tanzania','tanzania, united republic of'],
    ['iran','iran (islamic republic of)'], ['macedonia','north macedonia']
  ]);

  function normalizeName(str){
    return str.toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z\s]/g,'').replace(/\s+/g,' ').trim();
  }
  function canonical(str){
    const n = normalizeName(str);
    return alias.get(n) || n;
  }

  // Lock/unlock user interaction (zoom/rotate/pan/autorotate) during countdown
  function lockGlobe(lock){
    if (!globe) return;
    const c = globe.controls();
    c.enableZoom = !lock;
    c.enableRotate = !lock;
    c.enablePan = !lock;
    c.autoRotate = !lock; // pause autorotate while guessing
  }

  // Ensure perfect centering of selected country
  function ensurePerfectCentering() {
    if (!globe || !selected) return;
    
    let lat, lng;
    try {
      [lat, lng] = d3.geoCentroid(selected);
      if (!isFinite(lat) || !isFinite(lng)) throw new Error('bad centroid');
    } catch {
      const b = d3.geoBounds(selected);
      lat = (b[0][1] + b[1][1]) / 2;
      lng = (b[0][0] + b[1][0]) / 2;
    }
    
    // Force precise centering without animation
    globe.pointOfView({ lat, lng, altitude: 1.8 }, 0);
  }

  // --- Helper: hard-center the selected feature on screen ---
  function centerOnSelected(duration = 1200, altitude = 1.8) {
    if (!globe || !selected) return;

    // Compute robust center (centroid, else bounds mid)
    let lat, lng;
    try {
      [lat, lng] = d3.geoCentroid(selected);
      if (!isFinite(lat) || !isFinite(lng)) throw new Error('bad centroid');
    } catch {
      const b = d3.geoBounds(selected);
      lat = (b[0][1] + b[1][1]) / 2;
      lng = (b[0][0] + b[1][0]) / 2;
    }

    // Stop any inertial motion first
    const controls = globe.controls();
    controls.autoRotate = false;
    controls.update?.();

    // Add some random rotation before centering for more dynamic movement
    const randomLat = (Math.random() - 0.5) * 60; // ¬±30 degrees
    const randomLng = (Math.random() - 0.5) * 120; // ¬±60 degrees
    
    // First move to random position, then to target
    globe.pointOfView({ lat: randomLat, lng: randomLng, altitude: 2.5 }, duration * 0.4);
    
    setTimeout(() => {
      // Then smoothly center on the selected country
      globe.pointOfView({ lat, lng, altitude }, duration * 0.6);
      
      // Final precise centering to ensure perfect alignment
      setTimeout(() => {
        globe.pointOfView({ lat, lng, altitude }, 200);
      }, duration * 0.6 + 100);
    }, duration * 0.4);
  }

  // ---------- Initialize Globe ----------
  (async function init(){
    try {
      globe = Globe()
        .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
        .backgroundColor('rgba(0,0,0,0)')
        .showAtmosphere(true)
        .atmosphereAltitude(0.22)
        .atmosphereColor('#bfe4ff')
        .enablePointerInteraction(true)
        .polygonAltitude(d => d === selected ? 0.03 : 0.008)
        .polygonStrokeColor(d => d === selected ? '#00E5FF' : 'rgba(255,255,255,0.55)')
        .polygonCapColor(d => d === selected ? 'rgba(0,229,255,0.35)' : 'rgba(60,140,255,0.08)')
        .polygonSideColor(() => 'rgba(0, 100, 200, 0.18)')
        .pointOfView({ lat: 15, lng: 0, altitude: 2.15 })
        (document.getElementById('globeViz'));

      // Lock render size to fixed container
      globe.width(460).height(460);

      // Gentle auto-rotate when idle
      globe.controls().autoRotate = true;
      globe.controls().autoRotateSpeed = 0.35;
      globe.controls().enableDamping = true;
      globe.controls().dampingFactor = 0.05;

      // Load country polygons (GeoJSON)
      const geo = await fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson').then(r=>r.json());
      worldFeatures = geo.features.filter(f => f.geometry && (f.properties.name || f.properties.ADMIN));
      globe.polygonsData(worldFeatures);
    } catch (e){
      document.getElementById('globeViz').innerHTML = '<div style="color:#fff; padding:20px;">Error loading globe. Please refresh.</div>';
      console.error(e);
    }
  })();

  // ---------- Game Flow ----------
  function spin(){
    if (spinning || !worldFeatures.length) return;
    spinning = true;

    // Select random country
    selected = worldFeatures[Math.floor(Math.random() * worldFeatures.length)];

    // Refresh highlight styling immediately
    globe.polygonsData(worldFeatures);
    globe.polygonAltitude(globe.polygonAltitude());

    // Lock interactions while spinning
    lockGlobe(true);

    // Start the smooth centering animation
    centerOnSelected(1400, 1.8);

    // Update UI after a short delay to let the animation start
    setTimeout(() => {
      maskedNameEl.textContent = '???';
      guessInput.value = '';
      guessInput.disabled = false;
      guessInput.focus();

      timeLeft = 10;
      timerEl.style.color = '#ff4444';
      updateTimer();
      if (timerId) clearInterval(timerId);
      timerId = setInterval(tick, 1000);
    }, 200);

    // Allow spinning again after animation completes and ensure perfect centering
    setTimeout(() => { 
      ensurePerfectCentering();
      spinning = false; 
    }, 1400);
  }

  function tick(){
    timeLeft -= 1;
    updateTimer();
    if (timeLeft <= 0){
      clearInterval(timerId);
      reveal(false);
    }
  }
  function updateTimer(){
    timerEl.textContent = String(timeLeft);
    if (timeLeft <= 3) timerEl.style.color = '#ff0000';
  }

  function reveal(wasCorrect){
    const name = (selected?.properties?.name || selected?.properties?.ADMIN || '');
    maskedNameEl.textContent = name;
    if (wasCorrect){
      msgEl.textContent = '‚úÖ Correct!';
      setTimeout(()=>{ msgEl.textContent = ''; }, 1200);
    } else {
      msgEl.textContent = `‚ùå Time's up! The country was ${name}`;
      addStrike();
      setTimeout(()=>{ msgEl.textContent = ''; }, 1800);
    }
    // unlock controls now that round ended
    lockGlobe(false);
  }

  function submit(){
    if (!selected || timeLeft <= 0) return;
    const targetName = (selected.properties.name || selected.properties.ADMIN || '');

    const user = canonical(guessInput.value);
    const target = canonical(targetName);

    if (user && user === target){
      score += 1;
      document.getElementById('score').textContent = `Score: ${score}`;
      clearInterval(timerId);
      reveal(true);
    } else {
      msgEl.textContent = '‚ùå Try again';
      setTimeout(()=>{ msgEl.textContent = ''; }, 800);
    }
  }

  function addStrike(){
    strikes += 1;
    const sEl = document.getElementById(`s${strikes}`);
    if (sEl) sEl.classList.add('used');
    if (strikes >= 3){ end(); }
  }

  function end(){
    clearInterval(timerId);
    msgEl.textContent = `üéâ Game Over! Final Score: ${score}`;
    playAgainBtn.style.display = 'inline-block';
    submitBtn.style.display = 'none';
    spinBtn.style.display = 'none';
    guessInput.disabled = true;

    const oldHigh = Number(localStorage.getItem(highKey) || 0);
    if (score > oldHigh){
      localStorage.setItem(highKey, String(score));
      document.getElementById('high').textContent = `High Score: ${score}`;
    }
    // allow idle rotation on game over
    lockGlobe(false);
  }

  function reset(){
    score = 0; strikes = 0; timeLeft = 10; selected = null;
    document.getElementById('score').textContent = `Score: ${score}`;
    ['s1','s2','s3'].forEach(id => document.getElementById(id).classList.remove('used'));
    playAgainBtn.style.display = 'none';
    submitBtn.style.display = 'inline-block';
    spinBtn.style.display = 'inline-block';
    guessInput.disabled = false; guessInput.value = '';
    msgEl.textContent = '';

    globe.pointOfView({ lat: 15, lng: 0, altitude: 2.15 }, 800);
    // idle: unlock & autorotate resumes
    lockGlobe(false);
  }

  // ---------- Events ----------
  submitBtn.addEventListener('click', submit);
  spinBtn.addEventListener('click', spin);
  playAgainBtn.addEventListener('click', () => { reset(); setTimeout(spin, 400); });
  guessInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') submit(); });

  // Fallback if libraries don't load
  setTimeout(() => {
    if (typeof Globe === 'undefined') {
      document.getElementById('globeViz').innerHTML = `
        <div style="color: white; padding: 40px; text-align: center;">
          <h3>Globe Loading Error</h3>
          <p>Please check your internet connection and refresh the page.</p>
          <button onclick="location.reload()" style="background: #3b7bbf; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; margin-top: 10px;">
            Refresh Page
          </button>
        </div>
      `;
    }
  }, 5000);
  </script>
</body>
</html>
