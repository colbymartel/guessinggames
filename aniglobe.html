<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spin The Globe | Guessing Games</title>
  <link rel="icon" href="/favicongg.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Montserrat', sans-serif;
      background: radial-gradient(circle at 20% 15%, #66a6ff 0%, #3b7bbf 40%, #2a5a8a 100%);
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    nav {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      padding: 14px 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    nav .left a { color:#333; text-decoration:none; margin-right:16px; font-weight:600; }
    nav .right { display:flex; gap:10px; align-items:center; }
    .search { padding: 8px 12px; height: 38px; width: 240px; border-radius: 20px; border: 2px solid #e0e0e0; }
    .btn {
      background: linear-gradient(135deg, #ff7ac6, #8a7dff);
      color: #fff; border: none; padding: 10px 18px;
      border-radius: 20px; font-weight: 700; cursor:pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
      transition: transform .08s ease;
    }
    .btn:active { transform: translateY(1px) }

    main {
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: calc(100vh - 80px);
      padding: 20px;
    }
    h1 { color: #fff; font-size: 2.4rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px; }
    .stats {
      display:inline-flex; gap:14px; align-items:center;
      margin: 12px 0 25px; padding: 12px 18px; border-radius: 22px;
      background: rgba(255,255,255,0.95); font-weight: 700;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* FIXED globe size: always 460x460 */
    .globe-wrap {
      position: relative;
      width: 460px;
      height: 460px;
      margin: 0 auto 30px;
      border-radius: 26px;
      overflow: hidden;
      background:
        radial-gradient(ellipse at center, rgba(255,255,255,0.18), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.08));
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        inset 0 0 0 3px rgba(255,255,255,0.25),
        0 14px 40px rgba(0,0,0,0.25);
    }
    #globeViz {
      width: 100%;
      height: 100%;
      display:flex; align-items:center; justify-content:center;
    }
    .pointer {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      width:0; height:0; border-left: 16px solid transparent; border-right: 16px solid transparent;
      border-top: 26px solid #111; z-index: 5;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    .panel {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
      margin: 0 auto 20px; padding: 20px; border-radius: 16px; max-width: 560px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .country-name { font-size: 1.5rem; font-weight: 800; color:#333; margin-bottom: 8px; }
    .timer { font-size: 2rem; font-weight: 800; color:#ff4444; margin: 12px 0; }

    .input { margin: 15px 0; }
    .guess {
      padding: 14px 16px; font-size: 1.05rem; border: 2px solid #e0e0e0; border-radius: 26px;
      width: 320px; font-family: 'Montserrat', sans-serif;
    }
    .guess:focus { outline: none; border-color: #8a7dff; box-shadow: 0 0 0 4px rgba(138,125,255,0.18);}
    .controls { margin-top: 15px; display:flex; justify-content:center; gap:12px; flex-wrap: wrap; }

    .strikes { display:flex; justify-content:center; gap:10px; margin: 15px 0; }
    .strike { width: 30px; height: 30px; border-radius: 50%; background:#f0f0f0; border:2px solid #111; }
    .strike.used { background:#ff6b6b; border-color:#111; }

    #message {
      color:#fff; font-size:1.1rem; font-weight:700;
      text-shadow:0 2px 4px rgba(0,0,0,0.35); min-height: 28px; margin-top: 10px;
    }
    #playAgain { display:none; }

    /* Tiny screens: allow horizontal scroll instead of shrinking globe */
    @media (max-width: 480px){
      body { overflow-x: auto; }
    }

    /* Emoji confetti container */
    .confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .confetti span {
      position: absolute;
      font-size: 20px;
      animation: fall 900ms ease forwards;
      opacity: 0.95;
    }
    @keyframes fall {
      0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      100% { transform: translateY(120%) rotate(300deg); opacity: 0; }
    }
  </style>
</head>
<body>
  <nav>
    <div class="left">
      <a href="/index.html">Home</a>
      <a href="/allgames.html">Games</a>
      <a href="/about.html">About</a>
    </div>
    <div class="right">
      <input class="search" placeholder="Search games..." />
      <button class="btn">Login</button>
    </div>
  </nav>

  <main>
    <h1>üåç Spin The Globe</h1>
    <div class="stats">
      <div id="score">Score: 0</div>
      <div>|</div>
      <div id="high">High Score: 0</div>
    </div>

    <div class="globe-wrap">
      <div class="pointer"></div>
      <div id="globeViz">
        <div style="color: white; padding: 20px; text-align: center; font-size: 1.2rem;">
          Loading Cartoon Globe...
        </div>
      </div>
      <div class="confetti" id="confetti"></div>
    </div>

    <div class="panel" id="countryPanel">
      <div class="country-name" id="maskedName">Click "Spin Globe" to start!</div>
      <div class="timer" id="timer">10</div>
      <div class="input">
        <input id="guess" class="guess" placeholder="Type the country name..." autocomplete="off" />
      </div>
      <div class="controls">
        <button class="btn" id="submitBtn">Submit</button>
        <button class="btn" id="spinBtn">Spin Globe</button>
        <button class="btn" id="playAgain">Play Again</button>
      </div>
    </div>

    <div class="strikes">
      <div class="strike" id="s1"></div>
      <div class="strike" id="s2"></div>
      <div class="strike" id="s3"></div>
    </div>

    <div id="message"></div>
  </main>

  <!-- libs -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/d3@7"></script>
  <script src="https://unpkg.com/globe.gl@2.32.1/dist/globe.gl.min.js"></script>

  <script>
  // ---------- Game State ----------
  let globe, worldFeatures = [], selected = null, timerId = null, pulseId = null;
  let score = 0, strikes = 0, timeLeft = 10, spinning = false;
  const highKey = 'globeGameHighScoreV4';
  const highVal = Number(localStorage.getItem(highKey) || 0);
  document.getElementById('high').textContent = `High Score: ${highVal}`;

  const maskedNameEl = document.getElementById('maskedName');
  const timerEl = document.getElementById('timer');
  const msgEl = document.getElementById('message');
  const guessInput = document.getElementById('guess');
  const submitBtn = document.getElementById('submitBtn');
  const spinBtn = document.getElementById('spinBtn');
  const playAgainBtn = document.getElementById('playAgain');
  const confettiEl = document.getElementById('confetti');

  // Alias map for common country name variants
  const alias = new Map([
    ['usa','united states'], ['u.s.a','united states'], ['us','united states'], ['united states of america','united states'],
    ['russian federation','russia'], ['uk','united kingdom'], ['u.k','united kingdom'], ['england','united kingdom'],
    ['south korea','korea, republic of'], ['north korea','korea, democratic people\'s republic of'],
    ['congo','democratic republic of the congo'], ['drc','democratic republic of the congo'],
    ['czechia','czech republic'], ['eswatini','swaziland'], ['cape verde','cabo verde'],
    ['ivory coast','c√¥te d\'ivoire'], ['republic of the congo','congo'], ['bolivia','bolivia (plurinational state of)'],
    ['venezuela','venezuela (bolivarian republic of)'], ['syria','syrian arab republic'],
    ['laos','lao people\'s democratic republic'], ['moldova','moldova, republic of'],
    ['palestine','palestine, state of'], ['tanzania','tanzania, united republic of'],
    ['iran','iran (islamic republic of)'], ['macedonia','north macedonia']
  ]);

  // --- Cartoon color palette ---
  const pastel = [
    '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF',
    '#E3BAFF', '#FFD6E0', '#BFF0FF', '#D2FFB8', '#FFF0B3'
  ];
  const outlineColor = '#111';          // bold outline for cartoony look
  const oceanColor = '#7ec8ff';         // flat ocean color
  const selectedFill = 'rgba(255,255,255,0.65)';

  // Color by stable hash ‚Üí keeps same country color each time
  function hashColor(name){
    let h = 0;
    for (let i=0;i<name.length;i++) h = (h*31 + name.charCodeAt(i)) | 0;
    const idx = Math.abs(h) % pastel.length;
    return pastel[idx];
  }

  function normalizeName(str){
    return str.toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z\s]/g,'').replace(/\s+/g,' ').trim();
  }
  function canonical(str){
    const n = normalizeName(str);
    return alias.get(n) || n;
  }

  // Lock/unlock user interaction during countdown
  function lockGlobe(lock){
    if (!globe) return;
    const c = globe.controls();
    c.enableZoom = !lock;
    c.enableRotate = !lock;
    c.enablePan = !lock;
    c.autoRotate = !lock; // pause autorotate while guessing
  }

  // Cute confetti when correct
  function confetti(){
    const emojis = ['üéâ','‚ú®','üéà','üåü','üéä','üí´'];
    for (let i=0; i<12; i++){
      const s = document.createElement('span');
      s.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      s.style.left = Math.random()*100 + '%';
      s.style.top = (Math.random()*10) + '%';
      s.style.animationDelay = (Math.random()*0.2) + 's';
      confettiEl.appendChild(s);
      setTimeout(()=> s.remove(), 1000);
    }
  }

  // Pulse the selected polygon a bit (cartoony "pop")
  function startPulse(){
    stopPulse();
    let t = 0;
    pulseId = setInterval(() => {
      t += 0.12;
      const base = 0.016;
      const extra = 0.012 * (0.5 + 0.5*Math.sin(t));
      globe.polygonAltitude(d => d === selected ? base + extra : 0.006);
    }, 60);
  }
  function stopPulse(){
    if (pulseId) clearInterval(pulseId);
    pulseId = null;
    if (globe) globe.polygonAltitude(d => d === selected ? 0.02 : 0.006);
  }

  // ---------- Initialize Globe ----------
  (async function init(){
    try {
      globe = Globe()
        // FLAT, CARTOONY ocean (no photoreal textures)
        .globeImageUrl(null)
        .backgroundColor('rgba(0,0,0,0)')
        .showAtmosphere(true)
        .atmosphereAltitude(0.35)
        .atmosphereColor('#ffffff') // soft white glow for toony highlight
        .enablePointerInteraction(true)
        .polygonAltitude(d => d === selected ? 0.02 : 0.006)
        .polygonStrokeColor(() => outlineColor)
        .polygonSideColor(() => 'rgba(0,0,0,0.08)')
        .polygonCapColor(d => d === selected ? selectedFill : (d && d.properties ? hashColor(d.properties.name || d.properties.ADMIN || '') : '#FFD6E0'))
        .pointOfView({ lat: 15, lng: 0, altitude: 2.1 })
        (document.getElementById('globeViz'));

      // FIX: lock render size to fixed container
      globe.width(460).height(460);

      // Paint the ocean: add a flat-color sphere behind the polygons
      const scene = globe.scene();
      const oceanGeom = new THREE.SphereGeometry(100, 64, 64);
      const oceanMat = new THREE.MeshBasicMaterial({ color: oceanColor });
      const oceanMesh = new THREE.Mesh(oceanGeom, oceanMat);
      scene.add(oceanMesh);

      // Gentle auto-rotate when idle (slightly faster for playful feel)
      globe.controls().autoRotate = true;
      globe.controls().autoRotateSpeed = 0.65;

      // Load country polygons (GeoJSON)
      const geo = await fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson').then(r=>r.json());
      worldFeatures = geo.features.filter(f => f.geometry && (f.properties.name || f.properties.ADMIN));
      globe.polygonsData(worldFeatures);

      // Slight tilt for toony vibe
      const pov = globe.pointOfView();
      globe.pointOfView({ lat: pov.lat + 5, lng: pov.lng - 10, altitude: pov.altitude }, 1200);

    } catch (e){
      document.getElementById('globeViz').innerHTML = '<div style="color:#fff; padding:20px;">Error loading globe. Please refresh.</div>';
      console.error(e);
    }
  })();

  // ---------- Game Flow ----------
  let countdownId = null;

  function spin(){
    if (spinning || !worldFeatures.length) return;
    spinning = true;

    selected = worldFeatures[Math.floor(Math.random() * worldFeatures.length)];
    globe.polygonsData(worldFeatures); // ensure selection styling recalculates

    // Compute a safe centroid (fallback to bounds center if needed)
    let lat, lng;
    try {
      [lat, lng] = d3.geoCentroid(selected);
      if (!isFinite(lat) || !isFinite(lng)) throw new Error('Bad centroid');
    } catch {
      const b = d3.geoBounds(selected);
      lat = (b[0][1] + b[1][1]) / 2;
      lng = (b[0][0] + b[1][0]) / 2;
    }

    // Center the selected country
    lockGlobe(true);
    stopPulse();
    globe.pointOfView({ lat, lng, altitude: 1.9 }, 900);
    setTimeout(startPulse, 950);

    // UI + timer
    maskedNameEl.textContent = '???';
    guessInput.value = '';
    guessInput.disabled = false;
    guessInput.focus();

    timeLeft = 10;
    timerEl.style.color = '#ff4444';
    updateTimer();
    if (timerId) clearInterval(timerId);
    timerId = setInterval(tick, 1000);

    setTimeout(()=>{ spinning = false; }, 1000);
  }

  function tick(){
    timeLeft -= 1;
    updateTimer();
    if (timeLeft <= 0){
      clearInterval(timerId);
      reveal(false);
    }
  }
  function updateTimer(){
    timerEl.textContent = String(timeLeft);
    if (timeLeft <= 3) timerEl.style.color = '#ff0000';
  }

  function reveal(wasCorrect){
    const name = (selected?.properties?.name || selected?.properties?.ADMIN || '');
    maskedNameEl.textContent = name;
    if (wasCorrect){
      msgEl.textContent = '‚úÖ Correct!';
      confetti();
      setTimeout(()=>{ msgEl.textContent = ''; }, 900);
    } else {
      msgEl.textContent = `‚ùå Time's up! The country was ${name}`;
      addStrike();
      setTimeout(()=>{ msgEl.textContent = ''; }, 1400);
    }
    // unlock controls now that round ended
    lockGlobe(false);
    stopPulse();
  }

  function submit(){
    if (!selected || timeLeft <= 0) return;
    const targetName = (selected.properties.name || selected.properties.ADMIN || '');

    const user = canonical(guessInput.value);
    const target = canonical(targetName);

    if (user && user === target){
      score += 1;
      document.getElementById('score').textContent = `Score: ${score}`;
      clearInterval(timerId);
      reveal(true);
    } else {
      msgEl.textContent = '‚ùå Try again';
      setTimeout(()=>{ msgEl.textContent = ''; }, 650);
    }
  }

  function addStrike(){
    strikes += 1;
    const sEl = document.getElementById(`s${strikes}`);
    if (sEl) sEl.classList.add('used');
    if (strikes >= 3){ end(); }
  }

  function end(){
    clearInterval(timerId);
    msgEl.textContent = `üéâ Game Over! Final Score: ${score}`;
    playAgainBtn.style.display = 'inline-block';
    submitBtn.style.display = 'none';
    spinBtn.style.display = 'none';
    guessInput.disabled = true;

    const oldHigh = Number(localStorage.getItem(highKey) || 0);
    if (score > oldHigh){
      localStorage.setItem(highKey, String(score));
      document.getElementById('high').textContent = `High Score: ${score}`;
    }
    // allow idle rotation on game over
    lockGlobe(false);
    stopPulse();
  }

  function reset(){
    score = 0; strikes = 0; timeLeft = 10; selected = null;
    document.getElementById('score').textContent = `Score: ${score}`;
    ['s1','s2','s3'].forEach(id => document.getElementById(id).classList.remove('used'));
    playAgainBtn.style.display = 'none';
    submitBtn.style.display = 'inline-block';
    spinBtn.style.display = 'inline-block';
    guessInput.disabled = false; guessInput.value = '';
    msgEl.textContent = '';

    globe.pointOfView({ lat: 15, lng: 0, altitude: 2.1 }, 600);
    lockGlobe(false);
    stopPulse();
  }

  // ---------- Events ----------
  submitBtn.addEventListener('click', submit);
  spinBtn.addEventListener('click', spin);
  playAgainBtn.addEventListener('click', () => { reset(); setTimeout(spin, 300); });
  guessInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') submit(); });

  // Fallback if libraries don't load
  setTimeout(() => {
    if (typeof Globe === 'undefined') {
      document.getElementById('globeViz').innerHTML = `
        <div style="color: white; padding: 40px; text-align: center;">
          <h3>Globe Loading Error</h3>
          <p>Please check your internet connection and refresh the page.</p>
          <button onclick="location.reload()" style="background: #8a7dff; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; margin-top: 10px;">
            Refresh Page
          </button>
        </div>
      `;
    }
  }, 5000);
  </script>
</body>
</html>
